<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket Portals - Solo D&D Adventure</title>

    <!-- NES.css for retro RPG styling -->
    <link href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css" rel="stylesheet" />
    <!-- Press Start 2P font for authentic 8-bit look -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- RPG Awesome icons -->
    <link href="https://cdn.jsdelivr.net/npm/rpg-awesome@0.2.0/css/rpg-awesome.min.css" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Press Start 2P', cursive;
            background: #212529;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        body {
            background-image:
                radial-gradient(ellipse at top, #1a1a2e 0%, transparent 50%),
                radial-gradient(ellipse at bottom, #16213e 0%, transparent 50%),
                linear-gradient(180deg, #0d0d1a 0%, #1a1a2e 50%, #0f3460 100%);
            background-attachment: fixed;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 20px;
        }

        .title {
            color: #f7d354;
            font-size: 1.5rem;
            text-shadow:
                3px 3px 0 #c9a227,
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #92cc41;
            font-size: 0.6rem;
        }

        /* Game container */
        .game-container {
            background: #212529;
        }

        .nes-container.is-dark {
            background-color: #212529;
        }

        /* Story area - increased canvas for better readability */
        .story-box {
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 0;
            background: #212529 !important;
            padding: 16px;
        }

        .story-box::-webkit-scrollbar {
            width: 12px;
        }

        .story-box::-webkit-scrollbar-track {
            background: #212529;
            border: 2px solid #fff;
        }

        .story-box::-webkit-scrollbar-thumb {
            background: #92cc41;
            border: 2px solid #fff;
        }

        /* Messages */
        .message {
            margin-bottom: 16px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-narrator {
            color: #fff;
        }

        .message-player {
            color: #92cc41;
            padding-left: 20px;
            border-left: 4px solid #92cc41;
        }

        .message-label {
            font-size: 0.5rem;
            margin-bottom: 6px;
            opacity: 0.7;
        }

        .message-narrator .message-label {
            color: #f7d354;
        }

        .message-player .message-label {
            color: #92cc41;
        }

        .message-text {
            font-size: 0.7rem;
            line-height: 2;
            letter-spacing: 0.02em;
        }

        /* Welcome message */
        .welcome {
            text-align: center;
            padding: 30px 20px;
            color: #adafbc;
        }

        .welcome h2 {
            color: #f7d354;
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .welcome p {
            font-size: 0.55rem;
            line-height: 2;
            margin-bottom: 20px;
        }

        .welcome .begin-btn {
            font-size: 0.6rem !important;
            padding: 16px 32px !important;
            animation: pulse 2s ease-in-out infinite;
        }

        .welcome i {
            font-size: 3rem;
            color: #f7d354;
            margin-bottom: 16px;
            display: block;
        }

        /* Choices section */
        .choices-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 4px dashed #444;
        }

        .choices-label {
            color: #f7d354;
            font-size: 0.5rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .choices-label i {
            font-size: 0.8rem;
        }

        .choice-btn {
            display: block;
            width: 100%;
            margin-bottom: 8px;
            text-align: left;
            font-size: 0.55rem !important;
            padding: 12px 16px !important;
        }

        .choice-btn:hover {
            transform: translateX(4px);
        }

        .choice-btn i {
            margin-right: 8px;
        }

        /* Input section */
        .input-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 4px dashed #444;
        }

        .input-label {
            color: #209cee;
            font-size: 0.5rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-label i {
            font-size: 0.8rem;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        .input-row .nes-input {
            flex: 1;
            font-size: 0.55rem !important;
        }

        .input-row .nes-btn {
            font-size: 0.5rem !important;
            white-space: nowrap;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #f7d354;
        }

        .loading.visible {
            display: block;
        }

        .loading-text {
            font-size: 0.5rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .loading i {
            font-size: 1.5rem;
            animation: bounce 0.6s ease-in-out infinite;
            display: block;
            margin-bottom: 12px;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Error */
        .error-box {
            display: none;
            margin: 16px 0;
        }

        .error-box.visible {
            display: block;
        }

        /* Session bar */
        .session-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            margin-top: 16px;
            background: #1a1a2e;
            border: 4px solid #444;
        }

        .session-info {
            color: #adafbc;
            font-size: 0.4rem;
        }

        .session-info i {
            color: #92cc41;
            margin-right: 4px;
        }

        .new-game-btn {
            font-size: 0.4rem !important;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 20px;
            color: #adafbc;
            font-size: 0.4rem;
        }

        footer a {
            color: #209cee;
            text-decoration: none;
        }

        footer a:hover {
            color: #92cc41;
        }

        /* Responsive */
        @media (max-width: 600px) {
            .title {
                font-size: 1rem;
            }

            .story-box {
                max-height: 250px;
            }

            .input-row {
                flex-direction: column;
            }

            .input-row .nes-btn {
                width: 100%;
            }

            .session-bar {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
        }

        /* Hide choices initially */
        .choices-section.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 class="title"><i class="ra ra-door-open"></i> Pocket Portals</h1>
            <p class="subtitle"><i class="ra ra-crossed-swords"></i> Solo D&D Adventure <i class="ra ra-crossed-swords"></i></p>
        </header>

        <section class="nes-container is-dark game-container">
            <!-- Story Display -->
            <div class="story-box" id="story">
                <div class="welcome">
                    <i class="ra ra-scroll-unfurled"></i>
                    <h2>Welcome, Adventurer!</h2>
                    <p>Your quest awaits. Choose your starting path or type your own action below.</p>
                    <button class="nes-btn is-primary begin-btn" id="begin-btn">
                        <i class="ra ra-player-lift"></i> Begin Quest
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <i class="ra ra-crystal-ball"></i>
                <span class="loading-text">The narrator consults the fates...</span>
            </div>

            <!-- Error -->
            <div class="nes-container is-rounded is-error error-box" id="error"></div>

            <!-- Choices -->
            <div class="choices-section hidden" id="choices-section">
                <div class="choices-label">
                    <i class="ra ra-forging"></i>
                    <span>Choose Your Path</span>
                </div>
                <div id="choices"></div>
            </div>

            <!-- Input -->
            <div class="input-section">
                <div class="input-label">
                    <i class="ra ra-quill-ink"></i>
                    <span>Or Write Your Own Destiny</span>
                </div>
                <div class="input-row">
                    <input
                        type="text"
                        id="action-input"
                        class="nes-input is-dark"
                        placeholder="What do you do?"
                        autocomplete="off"
                    >
                    <button class="nes-btn is-success" id="submit-btn">
                        <i class="ra ra-lightning-bolt"></i> Act
                    </button>
                </div>
            </div>
        </section>

        <!-- Session Bar -->
        <div class="session-bar">
            <span class="session-info">
                <i class="ra ra-player"></i>
                <span id="session-display">New Adventure</span>
            </span>
            <button class="nes-btn is-error new-game-btn" id="new-game-btn">
                <i class="ra ra-cycle"></i> New Game
            </button>
        </div>

        <footer>
            <p>
                Powered by
                <a href="https://docs.crewai.com" target="_blank">CrewAI</a> &
                <a href="https://anthropic.com" target="_blank">Claude</a>
                <br><br>
                <i class="ra ra-dragon"></i>
            </p>
        </footer>
    </div>

    <script>
        // ===== State =====
        let sessionId = null;
        let currentChoices = [];
        let isLoading = false;

        // ===== DOM Elements =====
        const storyBox = document.getElementById('story');
        const choicesSection = document.getElementById('choices-section');
        const choicesDiv = document.getElementById('choices');
        const actionInput = document.getElementById('action-input');
        const submitBtn = document.getElementById('submit-btn');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const sessionDisplay = document.getElementById('session-display');
        const newGameBtn = document.getElementById('new-game-btn');

        // ===== Helpers =====
        function addMessage(text, type) {
            // Remove welcome if present
            const welcome = storyBox.querySelector('.welcome');
            if (welcome) welcome.remove();

            const div = document.createElement('div');
            div.className = `message message-${type}`;

            const label = type === 'narrator' ? '‚öîÔ∏è Narrator' : 'üßô You';
            const icon = type === 'narrator' ? 'ra-scroll-unfurled' : 'ra-player';

            div.innerHTML = `
                <div class="message-label"><i class="ra ${icon}"></i> ${label}</div>
                <div class="message-text">${text}</div>
            `;

            storyBox.appendChild(div);
            storyBox.scrollTop = storyBox.scrollHeight;
        }

        function updateChoices(choices) {
            currentChoices = choices || [];

            if (currentChoices.length > 0) {
                choicesSection.classList.remove('hidden');
                choicesDiv.innerHTML = '';

                const icons = ['ra-axe', 'ra-speech-bubble', 'ra-boot-stomp'];

                currentChoices.forEach((choice, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'nes-btn choice-btn';
                    btn.innerHTML = `<i class="ra ${icons[i] || 'ra-hand'}"></i> ${choice}`;
                    btn.onclick = () => selectChoice(i + 1);
                    choicesDiv.appendChild(btn);
                });
            } else {
                choicesSection.classList.add('hidden');
            }
        }

        function setLoading(loading) {
            isLoading = loading;
            loadingDiv.classList.toggle('visible', loading);
            submitBtn.disabled = loading;
            actionInput.disabled = loading;

            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.disabled = loading;
            });
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('visible');
            setTimeout(() => errorDiv.classList.remove('visible'), 5000);
        }

        // ===== API =====
        async function sendAction(action, choiceIndex = null) {
            if (isLoading) return;

            setLoading(true);
            errorDiv.classList.remove('visible');

            // Show player action
            const playerAction = choiceIndex ? currentChoices[choiceIndex - 1] : action;
            addMessage(playerAction, 'player');

            try {
                const payload = {};

                if (choiceIndex) {
                    payload.choice_index = choiceIndex;
                } else {
                    payload.action = action;
                }

                if (sessionId) {
                    payload.session_id = sessionId;
                }

                const response = await fetch('/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();

                // Update session
                sessionId = data.session_id;
                sessionDisplay.textContent = `Quest: ${sessionId.substring(0, 8)}...`;

                // Show narrator response
                addMessage(data.narrative, 'narrator');

                // Update choices
                updateChoices(data.choices);

                // Clear input
                actionInput.value = '';

            } catch (err) {
                console.error('Error:', err);
                showError(`Quest failed: ${err.message}`);
            } finally {
                setLoading(false);
                actionInput.focus();
            }
        }

        function selectChoice(index) {
            sendAction(null, index);
        }

        function submitAction() {
            const action = actionInput.value.trim();
            if (action) sendAction(action);
        }

        async function startNewAdventure(shuffle = true) {
            setLoading(true);
            errorDiv.classList.remove('visible');

            try {
                const response = await fetch(`/start?shuffle=${shuffle}`);
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();

                // Update session
                sessionId = data.session_id;
                sessionDisplay.textContent = `Quest: ${sessionId.substring(0, 8)}...`;

                // Clear story and show welcome
                storyBox.innerHTML = '';
                addMessage(data.narrative, 'narrator');

                // Show starter choices
                updateChoices(data.choices);

            } catch (err) {
                console.error('Error:', err);
                showError(`Failed to start adventure: ${err.message}`);
            } finally {
                setLoading(false);
                actionInput.focus();
            }
        }

        function newGame() {
            sessionId = null;
            currentChoices = [];
            sessionDisplay.textContent = 'New Adventure';
            choicesSection.classList.add('hidden');
            storyBox.innerHTML = `
                <div class="welcome">
                    <i class="ra ra-scroll-unfurled"></i>
                    <h2>Welcome, Adventurer!</h2>
                    <p>Your quest awaits. Choose your starting path or type your own action below.</p>
                    <button class="nes-btn is-primary begin-btn" id="begin-btn">
                        <i class="ra ra-player-lift"></i> Begin Quest
                    </button>
                </div>
            `;
            actionInput.value = '';
            actionInput.focus();
        }

        // ===== Event Listeners =====
        submitBtn.addEventListener('click', submitAction);
        actionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitAction();
        });
        newGameBtn.addEventListener('click', newGame);

        // Begin Quest button (if present in initial state)
        const beginBtn = document.getElementById('begin-btn');
        if (beginBtn) {
            beginBtn.addEventListener('click', () => startNewAdventure(true));
        }

        // Also handle dynamically added begin buttons after newGame
        storyBox.addEventListener('click', (e) => {
            if (e.target.id === 'begin-btn' || e.target.closest('#begin-btn')) {
                startNewAdventure(true);
            }
        });

        // Focus on load
        actionInput.focus();
    </script>
</body>
</html>
