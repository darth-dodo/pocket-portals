<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Pocket Portals - Solo D&D Adventure</title>

    <!-- NES.css for retro RPG styling -->
    <link href="https://unpkg.com/nes.css@2.3.0/css/nes.min.css" rel="stylesheet" />
    <!-- Press Start 2P font for headers, Crimson Pro for readable narrative text -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- RPG Awesome icons -->
    <link href="https://cdn.jsdelivr.net/npm/rpg-awesome@0.2.0/css/rpg-awesome.min.css" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Press Start 2P', cursive;
            background: #212529;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        body {
            background-image:
                radial-gradient(ellipse at top, #1a1a2e 0%, transparent 50%),
                radial-gradient(ellipse at bottom, #16213e 0%, transparent 50%),
                linear-gradient(180deg, #0d0d1a 0%, #1a1a2e 50%, #0f3460 100%);
            background-attachment: fixed;
            padding: 20px;
            /* Safe area for notched devices */
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            padding-bottom: max(20px, env(safe-area-inset-bottom));
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
        }

        /* Reading mode toggle */
        .reading-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(26, 26, 46, 0.95);
            border: 3px solid #444;
            border-radius: 8px;
            padding: 10px 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reading-mode-toggle:hover {
            border-color: #f7d354;
            transform: scale(1.05);
        }

        .reading-mode-toggle i {
            color: #f7d354;
            font-size: 1.2rem;
        }

        /* Reading mode active - larger text, simpler styling */
        body.reading-mode .message-text {
            font-size: 1.25rem !important;
            line-height: 2 !important;
        }

        body.reading-mode .story-box {
            max-height: 600px !important;
        }

        body.reading-mode .message {
            padding: 24px 28px !important;
            margin-bottom: 28px !important;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px;
            background: linear-gradient(180deg, rgba(26,26,46,0.8) 0%, transparent 100%);
            border-radius: 8px;
        }

        .title {
            color: #f7d354;
            font-size: 1.8rem;
            text-shadow:
                4px 4px 0 #c9a227,
                -1px -1px 0 #000,
                1px -1px 0 #000,
                -1px 1px 0 #000,
                1px 1px 0 #000;
            margin-bottom: 12px;
            letter-spacing: 2px;
        }

        .subtitle {
            color: #92cc41;
            font-size: 0.65rem;
            letter-spacing: 1px;
        }

        /* Game container */
        .game-container {
            background: #212529;
            border-width: 6px !important;
        }

        .nes-container.is-dark {
            background-color: #212529;
        }

        /* Story area */
        .story-box {
            min-height: 400px;
            max-height: 520px;
            overflow-y: auto;
            margin-bottom: 0;
            background: linear-gradient(180deg, #1a1a2e 0%, #212529 100%) !important;
            padding: 32px;
            border-radius: 4px;
            scroll-behavior: smooth;
        }

        .story-box::-webkit-scrollbar {
            width: 14px;
        }

        .story-box::-webkit-scrollbar-track {
            background: #1a1a2e;
            border: 3px solid #444;
            border-radius: 4px;
        }

        .story-box::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #92cc41 0%, #6b9e32 100%);
            border: 3px solid #444;
            border-radius: 4px;
        }

        /* Messages */
        .message {
            margin-bottom: 28px;
            animation: fadeIn 0.4s ease-out;
            padding: 20px 24px;
            border-radius: 8px;
            position: relative;
        }

        /* Visual separator between messages */
        .message:not(:last-child)::after {
            content: '';
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, transparent, #444, transparent);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-narrator {
            color: #e8e8e8;
            background: rgba(15, 52, 96, 0.3);
            border-left: 4px solid #f7d354;
        }

        .message-keeper {
            color: #e8e8e8;
            background: rgba(32, 156, 238, 0.2);
            border-left: 4px solid #209cee;
        }

        .message-jester {
            color: #e8e8e8;
            background: rgba(242, 113, 28, 0.2);
            border-left: 4px solid #f2711c;
        }

        .message-player {
            color: #92cc41;
            background: rgba(146, 204, 65, 0.1);
            border-left: 4px solid #92cc41;
        }

        .message-label {
            font-size: 0.7rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .message-narrator .message-label {
            color: #f7d354;
        }

        .message-keeper .message-label {
            color: #209cee;
        }

        .message-jester .message-label {
            color: #f2711c;
        }

        .message-player .message-label {
            color: #92cc41;
        }

        .message-text {
            font-family: 'Crimson Pro', Georgia, serif;
            font-size: 1.15rem;
            line-height: 1.9;
            letter-spacing: 0.01em;
            color: #f5f5f5;
            font-weight: 400;
        }

        .message-text p {
            margin: 0 0 1.2em 0;
        }

        .message-text p:last-child {
            margin-bottom: 0;
        }

        /* Blinking cursor for streaming text */
        .streaming-text::after {
            content: '‚ñå';
            color: #f7d354;
            animation: blink 0.7s infinite;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* First letter drop cap for narrator immersion */
        .message-narrator .message-text p:first-child::first-letter {
            font-size: 2.2em;
            float: left;
            line-height: 1;
            margin-right: 8px;
            margin-top: 4px;
            color: #f7d354;
            font-weight: 600;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        /* Keeper uses a different style - more mechanical */
        .message-keeper .message-text {
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            letter-spacing: 0;
        }

        /* Jester is playful */
        .message-jester .message-text {
            font-style: italic;
        }

        /* Player actions are concise */
        .message-player .message-text {
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 1rem;
            font-weight: 500;
        }

        /* Welcome message */
        .welcome {
            text-align: center;
            padding: 40px 30px;
            color: #c4c6d0; /* Improved contrast */
        }

        .welcome h2 {
            color: #f7d354;
            font-size: 1rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #c9a227;
        }

        .welcome p {
            font-size: 0.75rem;
            line-height: 2.4;
            margin-bottom: 28px;
            max-width: 550px;
            margin-left: auto;
            margin-right: auto;
            color: #d8d8d8; /* Improved contrast */
        }

        .welcome .begin-btn {
            font-size: 0.7rem !important;
            padding: 20px 40px !important;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 4px 0 #1e6c28;
        }

        .welcome .begin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #1e6c28;
        }

        .welcome i {
            font-size: 4rem;
            color: #f7d354;
            margin-bottom: 20px;
            display: block;
            text-shadow: 3px 3px 0 #c9a227;
        }

        /* Choices section */
        .choices-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(26, 26, 46, 0.5);
            border-radius: 8px;
            border: 2px dashed #444;
        }

        .choices-label {
            color: #f7d354;
            font-size: 0.7rem;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .choices-label i {
            font-size: 1rem;
        }

        .choice-btn {
            display: block;
            width: 100%;
            margin-bottom: 14px;
            text-align: left;
            font-size: 0.75rem !important;
            padding: 18px 24px !important;
            transition: all 0.2s ease;
            border-radius: 4px;
            line-height: 1.6;
        }

        .choice-btn:last-child {
            margin-bottom: 0;
        }

        .choice-btn:hover {
            transform: translateX(8px);
            box-shadow: -4px 0 0 #f7d354;
        }

        .choice-btn i {
            margin-right: 12px;
            color: #f7d354;
        }

        /* Input section */
        .input-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(32, 156, 238, 0.1);
            border-radius: 8px;
            border: 2px dashed #444;
        }

        .input-label {
            color: #209cee;
            font-size: 0.7rem;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .input-label i {
            font-size: 1rem;
        }

        .input-row {
            display: flex;
            gap: 12px;
        }

        .input-row .nes-input {
            flex: 1;
            font-size: 0.75rem !important;
            padding: 14px !important;
        }

        .input-row .nes-btn {
            font-size: 0.7rem !important;
            white-space: nowrap;
            padding: 14px 24px !important;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
            color: #f7d354;
            background: rgba(26, 26, 46, 0.5);
            border-radius: 8px;
            margin-top: 16px;
        }

        .loading.visible {
            display: block;
        }

        .loading-text {
            font-size: 0.55rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .loading i {
            font-size: 2rem;
            animation: bounce 0.6s ease-in-out infinite;
            display: block;
            margin-bottom: 16px;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        /* Agent indicator */
        .agent-indicator {
            display: none;
            text-align: center;
            padding: 16px;
            margin-top: 16px;
            background: rgba(26, 26, 46, 0.5);
            border-radius: 8px;
            border: 2px solid #444;
        }

        .agent-indicator.visible {
            display: block;
        }

        .agent-indicator-text {
            font-size: 0.55rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .agent-indicator.narrator { border-color: #f7d354; }
        .agent-indicator.narrator .agent-indicator-text { color: #f7d354; }

        .agent-indicator.keeper { border-color: #209cee; }
        .agent-indicator.keeper .agent-indicator-text { color: #209cee; }

        .agent-indicator.jester { border-color: #f2711c; }
        .agent-indicator.jester .agent-indicator-text { color: #f2711c; }

        .agent-indicator i {
            font-size: 1.5rem;
            margin-bottom: 12px;
            display: block;
        }

        /* Error */
        .error-box {
            display: none;
            margin: 16px 0;
            font-size: 0.55rem;
        }

        .error-box.visible {
            display: block;
        }

        /* Session bar */
        .session-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            margin-top: 20px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border: 4px solid #444;
            border-radius: 8px;
        }

        .session-info {
            color: #c4c6d0; /* Improved contrast */
            font-size: 0.45rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .session-info i {
            color: #92cc41;
            font-size: 0.8rem;
        }

        .new-game-btn {
            font-size: 0.45rem !important;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 24px;
            padding: 16px;
            color: #c4c6d0; /* Improved contrast */
            font-size: 0.45rem;
        }

        footer a {
            color: #209cee;
            text-decoration: none;
            transition: color 0.2s;
        }

        footer a:hover {
            color: #92cc41;
        }

        footer i {
            font-size: 1.5rem;
            display: block;
            margin-top: 12px;
            opacity: 0.6;
        }

        /* Responsive - Tablet */
        @media (max-width: 768px) {
            .reading-mode-toggle {
                top: 12px;
                right: 12px;
                padding: 10px 14px;
            }

            .message-text {
                font-size: 1.15rem;
                line-height: 1.95;
            }

            .choice-btn {
                min-height: 52px;
                font-size: 0.85rem !important;
            }
        }

        /* Responsive - Mobile */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            /* Compact header on mobile */
            header {
                margin-bottom: 16px;
                padding: 12px;
            }

            .title {
                font-size: 1.1rem;
                margin-bottom: 8px;
            }

            .subtitle {
                font-size: 0.5rem;
                display: none; /* Hide subtitle to save space */
            }

            /* Reading mode toggle - fixed bottom right FAB style */
            .reading-mode-toggle {
                position: fixed;
                bottom: max(20px, env(safe-area-inset-bottom));
                right: max(20px, env(safe-area-inset-right));
                top: auto;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                z-index: 1000;
            }

            .reading-mode-toggle i {
                font-size: 1.4rem;
            }

            /* Story area - more space for content */
            .story-box {
                min-height: 280px;
                max-height: none; /* Remove max-height constraint */
                padding: 16px;
                margin-bottom: 0;
            }

            /* Messages - improved readability */
            .message {
                padding: 18px 16px;
                margin-bottom: 24px;
                border-radius: 6px;
            }

            .message-text {
                font-size: 1.125rem; /* 18px - comfortable mobile reading */
                line-height: 1.9;
                letter-spacing: 0.02em;
            }

            .message-label {
                font-size: 0.65rem;
                margin-bottom: 10px;
            }

            /* Smaller drop cap on mobile */
            .message-narrator .message-text p:first-child::first-letter {
                font-size: 1.6em;
                margin-right: 6px;
            }

            /* Keeper text slightly larger on mobile */
            .message-keeper .message-text {
                font-size: 1rem;
                line-height: 1.7;
            }

            /* Player text */
            .message-player .message-text {
                font-size: 1rem;
            }

            /* Welcome screen */
            .welcome {
                padding: 28px 20px;
            }

            .welcome p {
                font-size: 1rem;
                font-family: 'Crimson Pro', Georgia, serif;
                line-height: 1.8;
                color: #d8d8d8;
            }

            .welcome i {
                font-size: 2.5rem;
            }

            .welcome h2 {
                font-size: 0.85rem;
                margin-bottom: 16px;
            }

            .welcome .begin-btn {
                font-size: 0.75rem !important;
                padding: 18px 36px !important;
                min-height: 56px;
            }

            /* Choices - larger touch targets */
            .choices-section {
                padding: 16px;
                margin-top: 16px;
            }

            .choices-label {
                font-size: 0.65rem;
                margin-bottom: 14px;
            }

            .choice-btn {
                font-size: 1rem !important; /* Readable size */
                font-family: 'Inter', system-ui, sans-serif;
                padding: 16px 20px !important;
                min-height: 56px; /* Touch-friendly */
                margin-bottom: 12px;
                line-height: 1.5;
                display: flex;
                align-items: center;
            }

            .choice-btn i {
                font-size: 1.1rem;
                flex-shrink: 0;
            }

            /* Input section */
            .input-section {
                padding: 16px;
                margin-top: 16px;
            }

            .input-label {
                font-size: 0.65rem;
                margin-bottom: 14px;
            }

            .input-row {
                flex-direction: column;
                gap: 10px;
            }

            .input-row .nes-input {
                font-family: 'Inter', system-ui, sans-serif;
                font-size: 16px !important; /* Prevents iOS zoom */
                min-height: 52px;
                padding: 14px 16px !important;
            }

            .input-row .nes-btn {
                width: 100%;
                min-height: 52px;
                font-size: 0.8rem !important;
            }

            /* Loading indicator */
            .loading {
                padding: 24px;
            }

            .loading-text {
                font-size: 0.6rem;
            }

            /* Agent indicator */
            .agent-indicator {
                padding: 14px;
            }

            .agent-indicator-text {
                font-size: 0.6rem;
            }

            /* Session bar */
            .session-bar {
                flex-direction: column;
                gap: 12px;
                text-align: center;
                padding: 14px 16px;
                margin-top: 16px;
            }

            .session-info {
                font-size: 0.5rem;
            }

            .new-game-btn {
                font-size: 0.5rem !important;
                min-height: 44px;
                padding: 12px 20px !important;
            }

            /* Footer */
            footer {
                margin-top: 20px;
                padding: 14px;
                font-size: 0.5rem;
            }

            /* Reading mode enhancements for mobile */
            body.reading-mode .message-text {
                font-size: 1.25rem !important; /* 20px */
                line-height: 2.1 !important;
            }

            body.reading-mode .message {
                padding: 22px 18px !important;
            }

            body.reading-mode .story-box {
                padding: 20px;
            }

            /* Error box */
            .error-box {
                font-size: 0.6rem;
                padding: 14px;
            }
        }

        /* Extra small mobile (320px - older/smaller phones) */
        @media (max-width: 380px) {
            body {
                padding: 8px;
            }

            .title {
                font-size: 0.95rem;
            }

            .story-box {
                padding: 14px;
            }

            .message {
                padding: 14px 12px;
            }

            .message-text {
                font-size: 1.0625rem; /* 17px */
            }

            .choice-btn {
                font-size: 0.9375rem !important; /* 15px */
                padding: 14px 16px !important;
            }

            .welcome h2 {
                font-size: 0.75rem;
            }

            .welcome p {
                font-size: 0.9375rem;
            }
        }

        /* Accessibility: Respect reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .message-text {
                color: #ffffff;
            }

            .message-label {
                font-weight: bold;
            }

            .choice-btn {
                border-width: 3px;
            }
        }

        /* Hide choices initially */
        .choices-section.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Reading Mode Toggle -->
    <button class="reading-mode-toggle" id="reading-toggle" title="Toggle Reading Mode">
        <i class="ra ra-book"></i>
    </button>

    <div class="container">
        <header>
            <h1 class="title"><i class="ra ra-door-open"></i> Pocket Portals</h1>
            <p class="subtitle"><i class="ra ra-crossed-swords"></i> Solo D&D Adventure <i class="ra ra-crossed-swords"></i></p>
        </header>

        <section class="nes-container is-dark game-container">
            <!-- Story Display -->
            <div class="story-box" id="story">
                <div class="welcome">
                    <i class="ra ra-scroll-unfurled"></i>
                    <h2>Welcome, Adventurer!</h2>
                    <p>Your quest awaits. Choose your starting path or type your own action below.</p>
                    <button class="nes-btn is-primary begin-btn" id="begin-btn">
                        <i class="ra ra-player-lift"></i> Begin Quest
                    </button>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <i class="ra ra-crystal-ball"></i>
                <span class="loading-text">The narrator consults the fates...</span>
            </div>

            <!-- Agent Indicator -->
            <div class="agent-indicator" id="agent-indicator">
                <i class="ra ra-scroll-unfurled"></i>
                <span class="agent-indicator-text" id="agent-indicator-text">Narrator is speaking...</span>
            </div>

            <!-- Error -->
            <div class="nes-container is-rounded is-error error-box" id="error"></div>

            <!-- Choices -->
            <div class="choices-section hidden" id="choices-section">
                <div class="choices-label">
                    <i class="ra ra-forging"></i>
                    <span>Choose Your Path</span>
                </div>
                <div id="choices"></div>
            </div>

            <!-- Input -->
            <div class="input-section">
                <div class="input-label">
                    <i class="ra ra-quill-ink"></i>
                    <span>Or Write Your Own Destiny</span>
                </div>
                <div class="input-row">
                    <input
                        type="text"
                        id="action-input"
                        class="nes-input is-dark"
                        placeholder="What do you do?"
                        autocomplete="off"
                    >
                    <button class="nes-btn is-success" id="submit-btn">
                        <i class="ra ra-lightning-bolt"></i> Act
                    </button>
                </div>
            </div>
        </section>

        <!-- Session Bar -->
        <div class="session-bar">
            <span class="session-info">
                <i class="ra ra-player"></i>
                <span id="session-display">New Adventure</span>
            </span>
            <button class="nes-btn is-error new-game-btn" id="new-game-btn">
                <i class="ra ra-cycle"></i> New Game
            </button>
        </div>

        <footer>
            <p>
                Powered by
                <a href="https://docs.crewai.com" target="_blank">CrewAI</a> &
                <a href="https://anthropic.com" target="_blank">Claude</a>
                <br><br>
                <i class="ra ra-dragon"></i>
            </p>
        </footer>
    </div>

    <script>
        // ===== State =====
        let sessionId = null;
        let currentChoices = [];
        let isLoading = false;

        // ===== DOM Elements =====
        const storyBox = document.getElementById('story');
        const choicesSection = document.getElementById('choices-section');
        const choicesDiv = document.getElementById('choices');
        const actionInput = document.getElementById('action-input');
        const submitBtn = document.getElementById('submit-btn');
        const loadingDiv = document.getElementById('loading');
        const agentIndicator = document.getElementById('agent-indicator');
        const agentIndicatorText = document.getElementById('agent-indicator-text');
        const errorDiv = document.getElementById('error');
        const sessionDisplay = document.getElementById('session-display');
        const newGameBtn = document.getElementById('new-game-btn');

        // ===== Helpers =====
        const agentConfig = {
            narrator: { label: '‚öîÔ∏è Narrator', icon: 'ra-scroll-unfurled' },
            keeper: { label: 'üé≤ Keeper', icon: 'ra-dice' },
            jester: { label: 'üé≠ Jester', icon: 'ra-mask' },
            player: { label: 'üßô You', icon: 'ra-player' }
        };

        // Track the current streaming message element
        let streamingMessageEl = null;
        let streamingTextEl = null;
        let streamingContent = '';

        function addMessage(text, type) {
            // Remove welcome if present
            const welcome = storyBox.querySelector('.welcome');
            if (welcome) welcome.remove();

            const div = document.createElement('div');
            div.className = `message message-${type}`;

            const config = agentConfig[type] || agentConfig.narrator;

            // Convert newlines to <br> for proper rendering
            const formattedText = text.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');

            div.innerHTML = `
                <div class="message-label"><i class="ra ${config.icon}"></i> ${config.label}</div>
                <div class="message-text"><p>${formattedText}</p></div>
            `;

            storyBox.appendChild(div);
            storyBox.scrollTop = storyBox.scrollHeight;
        }

        function startStreamingMessage(type) {
            // Remove welcome if present
            const welcome = storyBox.querySelector('.welcome');
            if (welcome) welcome.remove();

            // Create the message container
            streamingMessageEl = document.createElement('div');
            streamingMessageEl.className = `message message-${type}`;

            const config = agentConfig[type] || agentConfig.narrator;

            streamingMessageEl.innerHTML = `
                <div class="message-label"><i class="ra ${config.icon}"></i> ${config.label}</div>
                <div class="message-text"><p class="streaming-text"></p></div>
            `;

            storyBox.appendChild(streamingMessageEl);
            streamingTextEl = streamingMessageEl.querySelector('.streaming-text');
            streamingContent = '';
        }

        function appendStreamingChar(char) {
            if (!streamingTextEl) return;

            streamingContent += char;
            // Convert newlines for display
            const formattedText = streamingContent
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            streamingTextEl.innerHTML = formattedText;

            // Keep scrolled to bottom
            storyBox.scrollTop = storyBox.scrollHeight;
        }

        function endStreamingMessage() {
            // Remove blinking cursor by removing the streaming-text class
            if (streamingTextEl) {
                streamingTextEl.classList.remove('streaming-text');
            }
            // Clear streaming state
            streamingMessageEl = null;
            streamingTextEl = null;
            streamingContent = '';
        }

        function updateChoices(choices) {
            currentChoices = choices || [];

            if (currentChoices.length > 0) {
                choicesSection.classList.remove('hidden');
                choicesDiv.innerHTML = '';

                const icons = ['ra-axe', 'ra-speech-bubble', 'ra-boot-stomp'];

                currentChoices.forEach((choice, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'nes-btn choice-btn';
                    btn.innerHTML = `<i class="ra ${icons[i] || 'ra-hand'}"></i> ${choice}`;
                    btn.onclick = () => selectChoice(i + 1);
                    choicesDiv.appendChild(btn);
                });
            } else {
                choicesSection.classList.add('hidden');
            }
        }

        function setLoading(loading) {
            isLoading = loading;
            loadingDiv.classList.toggle('visible', loading);
            submitBtn.disabled = loading;
            actionInput.disabled = loading;

            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.disabled = loading;
            });
        }

        function showAgentIndicator(agent) {
            const agentNames = {
                narrator: 'Narrator is speaking...',
                keeper: 'Keeper is rolling the dice...',
                jester: 'Jester is intervening...'
            };

            agentIndicator.className = `agent-indicator ${agent} visible`;
            agentIndicatorText.textContent = agentNames[agent] || 'Agent is responding...';
        }

        function hideAgentIndicator() {
            agentIndicator.classList.remove('visible');
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.classList.add('visible');
            setTimeout(() => errorDiv.classList.remove('visible'), 5000);
        }

        // ===== API =====
        async function sendAction(action, choiceIndex = null) {
            if (isLoading) return;

            setLoading(true);
            errorDiv.classList.remove('visible');

            // Show player action
            const playerAction = choiceIndex ? currentChoices[choiceIndex - 1] : action;
            addMessage(playerAction, 'player');

            try {
                const payload = {};

                if (choiceIndex) {
                    payload.choice_index = choiceIndex;
                } else {
                    payload.action = action;
                }

                if (sessionId) {
                    payload.session_id = sessionId;
                }

                // Use Server-Sent Events for streaming responses
                const response = await fetch('/action/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                // Parse SSE stream
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let currentEventType = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || ''; // Keep incomplete line in buffer

                    for (const line of lines) {
                        if (line.startsWith('event:')) {
                            currentEventType = line.substring(6).trim();
                        } else if (line.startsWith('data:')) {
                            const data = JSON.parse(line.substring(5).trim());

                            // Handle different event types
                            if (currentEventType === 'routing') {
                                console.log('Routing:', data);
                            } else if (currentEventType === 'agent_start') {
                                showAgentIndicator(data.agent);
                                // Start streaming message for this agent
                                startStreamingMessage(data.agent);
                            } else if (currentEventType === 'agent_chunk') {
                                // Append character to streaming message
                                appendStreamingChar(data.chunk);
                            } else if (currentEventType === 'agent_response') {
                                hideAgentIndicator();
                                // If we were streaming, just clean up (message already shown)
                                // If not streaming, add the full message
                                if (streamingMessageEl) {
                                    endStreamingMessage();
                                } else {
                                    addMessage(data.content, data.agent);
                                }
                            } else if (currentEventType === 'choices') {
                                updateChoices(data.choices);
                            } else if (currentEventType === 'complete') {
                                sessionId = data.session_id;
                                sessionDisplay.textContent = `Quest: ${sessionId.substring(0, 8)}...`;
                            } else if (currentEventType === 'error') {
                                throw new Error(data.message);
                            }

                            // Reset after processing
                            currentEventType = '';
                        }
                    }
                }

                // Clear input
                actionInput.value = '';

            } catch (err) {
                console.error('Error:', err);
                showError(`Quest failed: ${err.message}`);
            } finally {
                hideAgentIndicator();
                setLoading(false);
                actionInput.focus();
            }
        }

        function selectChoice(index) {
            sendAction(null, index);
        }

        function submitAction() {
            const action = actionInput.value.trim();
            if (action) sendAction(action);
        }

        async function startNewAdventure(shuffle = true) {
            setLoading(true);
            errorDiv.classList.remove('visible');

            try {
                const response = await fetch(`/start?shuffle=${shuffle}`);
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();

                // Update session
                sessionId = data.session_id;
                sessionDisplay.textContent = `Quest: ${sessionId.substring(0, 8)}...`;

                // Clear story and show welcome
                storyBox.innerHTML = '';
                addMessage(data.narrative, 'narrator');

                // Show starter choices
                updateChoices(data.choices);

            } catch (err) {
                console.error('Error:', err);
                showError(`Failed to start adventure: ${err.message}`);
            } finally {
                setLoading(false);
                actionInput.focus();
            }
        }

        function newGame() {
            sessionId = null;
            currentChoices = [];
            sessionDisplay.textContent = 'New Adventure';
            choicesSection.classList.add('hidden');
            storyBox.innerHTML = `
                <div class="welcome">
                    <i class="ra ra-scroll-unfurled"></i>
                    <h2>Welcome, Adventurer!</h2>
                    <p>Your quest awaits. Choose your starting path or type your own action below.</p>
                    <button class="nes-btn is-primary begin-btn" id="begin-btn">
                        <i class="ra ra-player-lift"></i> Begin Quest
                    </button>
                </div>
            `;
            actionInput.value = '';
            actionInput.focus();
        }

        // ===== Event Listeners =====
        submitBtn.addEventListener('click', submitAction);
        actionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitAction();
        });
        newGameBtn.addEventListener('click', newGame);

        // Begin Quest button (if present in initial state)
        const beginBtn = document.getElementById('begin-btn');
        if (beginBtn) {
            beginBtn.addEventListener('click', () => startNewAdventure(true));
        }

        // Also handle dynamically added begin buttons after newGame
        storyBox.addEventListener('click', (e) => {
            if (e.target.id === 'begin-btn' || e.target.closest('#begin-btn')) {
                startNewAdventure(true);
            }
        });

        // Focus on load
        actionInput.focus();

        // ===== Reading Mode Toggle =====
        const readingToggle = document.getElementById('reading-toggle');
        const savedReadingMode = localStorage.getItem('readingMode') === 'true';

        if (savedReadingMode) {
            document.body.classList.add('reading-mode');
        }

        readingToggle.addEventListener('click', () => {
            document.body.classList.toggle('reading-mode');
            const isActive = document.body.classList.contains('reading-mode');
            localStorage.setItem('readingMode', isActive);
        });
    </script>
</body>
</html>
